<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorty - The Ultimate URL Shortener</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="background-animation"></div>

    <header class="site-header">
        <nav class="navbar">
            <div class="logo">
                <a href="/" class="logo-link">
    <div class="logo">
        <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path d="M200.7 224H288c17.7 0 32-14.3 32-32s-14.3-32-32-32H200.7c-25.1 0-48.4 12.1-62.8 32.5L78.6 243.9c-15.8 22.3-15.8 51.5 0 73.8l59.3 83.4c14.4 20.4 37.7 32.5 62.8 32.5H288c17.7 0 32-14.3 32-32s-14.3-32-32-32H200.7c-3.1 0-6.1-1.6-7.8-4.3l-59.3-83.4c-1.7-2.4-1.7-5.7 0-8.1l59.3-83.4c1.7-2.7 4.7-4.3 7.8-4.3zm111.4 0H312c-17.7 0-32 14.3-32 32s14.3 32 32 32h.7c25.1 0 48.4-12.1 62.8-32.5l59.3-83.4c15.8-22.3 15.8-51.5 0-73.8l-59.3-83.4C360.4 12.1 337.1 0 312 0h-.7c-17.7 0-32 14.3-32 32s14.3 32 32 32h.7c3.1 0 6.1 1.6 7.8 4.3l59.3 83.4c1.7 2.4 1.7 5.7 0 8.1l-59.3 83.4c-1.7 2.7-4.7 4.3-7.8 4.3z"/>
        </svg>
        <span class="logo-text">Shawty</span>
    </div>
</a>

            </div>
            <div class="nav-links">
                <a href="#features">Features</a>
                <!-- CORRECTED JINJA SYNTAX -->
                {% if current_user.is_authenticated %}
                    <a href="#history">History</a>
                    <a href="{{ url_for('logout') }}">Logout</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="nav-button">Login</a>
                    <a href="{{ url_for('signup') }}" class="nav-button">Sign Up</a>
                {% endif %}
            </div>
        </nav>
    </header>

    <div class="container">
        <h1 class="main-title">Shorten Your Links. Supercharge Your Reach.</h1>
        <p class="subtitle">A simple, fast, and reliable tool to transform long, ugly links into memorable and trackable short URLs.</p>
        
        <form id="url-form">
            <div class="input-wrapper">
                <i class="fas fa-globe"></i>
                <input type="text" id="url-input" class="styled-input" placeholder="Enter your long URL here..." required>
            </div>
            <div class="input-wrapper">
                <i class="fas fa-pencil-alt"></i>
                <input type="text" id="custom-slug" class="styled-input" placeholder="Optional: your-custom-name">
            </div>
            <button type="submit">Shorten Now</button>
        </form>
        
        <div id="result-container" class="hidden">
            <p>Your shortened URL is ready:</p>
            <div class="result-box">
                <a href="" id="short-url" target="_blank"></a>
                <button id="copy-button" title="Copy to clipboard"><i class="far fa-copy"></i></button>
            </div>
        </div>
    </div>
    
    <!-- CORRECTED JINJA SYNTAX -->
    {% if current_user.is_authenticated %}
    <section id="history" class="history-section">
        <h2>Your Link History</h2>
        <ul id="history-list">
            <!-- History items will be dynamically inserted here -->
        </ul>
    </section>
    {% endif %}

    <main id="features" class="features-section">
        <div class="features-grid">
            <div class="feature-card">
                <i class="fas fa-thumbs-up"></i>
                <h3>Easy</h3>
                <p>ShortURL is easy and fast, enter the long link to get your shortened link.</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-link"></i>
                <h3>Shortened</h3>
                <p>Use any link, no matter what size, ShortURL always shortens.</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-shield-halved"></i>
                <h3>Secure</h3>
                <p>It is fast and secure, our service has HTTPS protocol and data encryption.</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-chart-line"></i>
                <h3>Statistics</h3>
                <p>Check the number of clicks that your shortened URL received.</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-hand-paper"></i>
                <h3>Reliable</h3>
                <p>All links that try to disseminate spam, viruses and malware are deleted.</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-desktop"></i>
                <h3>Devices</h3>
                <p>Compatible with smartphones, tablets and desktop.</p>
            </div>
        </div>
    </main>

    <script>
        
        // --- Custom Confirm Function ---
    function showCustomConfirm(message) {
        return new Promise(resolve => {
            const overlay = document.getElementById('custom-confirm-overlay');
            const messageEl = document.getElementById('confirm-message');
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');

            messageEl.textContent = message;
            overlay.classList.add('visible');

            okBtn.onclick = () => {
                overlay.classList.remove('visible');
                resolve(true);
            };

            cancelBtn.onclick = () => {
                overlay.classList.remove('visible');
                resolve(false);
            };
        });
    }

    // --- Main Form Submission Logic ---
    document.getElementById('url-form').addEventListener('submit', async function(event) {
        event.preventDefault(); 
        const longUrl = document.getElementById('url-input').value;
        const customSlug = document.getElementById('custom-slug').value;
        const resultContainer = document.getElementById('result-container');
        const shortUrlLink = document.getElementById('short-url');

        try {
            const response = await fetch('/api/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    url: longUrl, 
                    custom_slug: customSlug 
                }),
            });

            const data = await response.json();

            if (data.short_url) {
                shortUrlLink.href = data.short_url;
                shortUrlLink.textContent = data.short_url;
                resultContainer.classList.remove('hidden');
                // If the user is logged in, refresh their history list
                if (document.getElementById('history-list')) {
                    fetchHistory();
                }
            } else {
                alert(data.error || 'An unknown error occurred.');
            }
        } catch (error) {
            console.error('Error during URL shortening:', error);
            alert('An error occurred while shortening the URL.');
        }
    });

    // --- Main Result Copy Button Logic ---
    document.getElementById('copy-button')?.addEventListener('click', function() {
        const urlToCopy = document.getElementById('short-url').href;
        navigator.clipboard.writeText(urlToCopy).then(() => {
            this.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => { this.innerHTML = '<i class="far fa-copy"></i>'; }, 2000);
        });
    });
    
    // --- Logic for Authenticated Users ---
    {% if current_user.is_authenticated %}
    // Function to fetch and display the user's link history
    async function fetchHistory() {
        const response = await fetch('/api/history');
        const history = await response.json();
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = ''; 

        if (history.length === 0) {
            historyList.innerHTML = '<li class="history-item-empty">You have no shortened links yet.</li>';
        } else {
            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <div class="history-long-url" title="${item.long_url}">${item.long_url}</div>
                    <div class="history-short-url">
                        <a href="/${item.short_code}" target="_blank">${window.location.host}/${item.short_code}</a>
                        <div class="history-actions">
                            <button class="history-copy-btn" data-url="${window.location.origin}/${item.short_code}" title="Copy link">
                                <i class="far fa-copy"></i>
                            </button>
                            <button class="history-delete-btn" data-code="${item.short_code}" title="Delete link">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                historyList.appendChild(li);
            });
        }
    }
    
    // Event listener for the entire history list to handle clicks on child buttons
    document.getElementById('history-list').addEventListener('click', async function(event) {
        const copyBtn = event.target.closest('.history-copy-btn');
        const deleteBtn = event.target.closest('.history-delete-btn');

        if (copyBtn) {
            const urlToCopy = copyBtn.dataset.url;
            navigator.clipboard.writeText(urlToCopy).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => { copyBtn.innerHTML = '<i class="far fa-copy"></i>'; }, 2000);
            });
        }

        if (deleteBtn) {
            const shortCodeToDelete = deleteBtn.dataset.code;
            const userConfirmed = await showCustomConfirm(`Are you sure you want to delete this link: ${shortCodeToDelete}?`);
            
            if (userConfirmed) {
                const response = await fetch(`/api/delete/${shortCodeToDelete}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    deleteBtn.closest('.history-item').remove();
                } else {
                    const errData = await response.json();
                    alert(errData.error || 'Error: Could not delete the link.');
                }
            }
        }
    });

    // Fetch the user's history when the page first loads
    document.addEventListener('DOMContentLoaded', fetchHistory);
    {% endif %}

</script>
    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="custom-confirm-overlay" class="confirm-overlay">
        <div class="confirm-box">
            <h3 class="confirm-title">Confirm Deletion</h3>
            <p id="confirm-message"></p>
            <div class="confirm-buttons">
                <button id="confirm-cancel" class="confirm-btn-secondary">Cancel</button>
                <button id="confirm-ok" class="confirm-btn-primary">OK</button>
            </div>
        </div>
    </div>

</body>
</html>
